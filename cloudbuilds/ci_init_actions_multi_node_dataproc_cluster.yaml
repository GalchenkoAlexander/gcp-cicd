steps:

  # copy init actions to GCS
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'copy_resources'
    args:
      - 'cp'
      - '-r'
      - 'dataproc/init-actions/*.sh'
      - 'gs://${_BUCKET_NAME}/$REPO_NAME/$BRANCH_NAME/$COMMIT_SHA/temp/dataproc/init-actoins/'

  ## create single node dataproc cluster
  - name: 'gcr.io/cloud-builders/gcloud'
    args:
      - 'dataproc'
      - 'clusters'
      - 'create'
      - '${_CLUSTER_NAME}'
      - '--region=${_REGION}'
      - '--zone=${_ZONE}'
      - '--master-machine-type=n1-standard-1'
      - '--num-workers=2'
      - '--worker-machine-type=n1-standard-1'
      - '--initialization-actions=gs://${_BUCKET_NAME}/${REPO_NAME}/${BRANCH_NAME}/${COMMIT_SHA}/temp/dataproc/init-actoins/add_hive_jars.sh'
      - '--metadata=hive-aux-libs=gs://${_BUCKET_NAME}/${REPO_NAME}/${BRANCH_NAME}/${COMMIT_SHA}/hive-aux-libs/'

  ## Run teragen test
  - name: 'gcr.io/cloud-builders/gcloud'
    args:
      - 'dataproc'
      - 'jobs'
      - 'submit'
      - 'hadoop'
      - '--cluster=${_CLUSTER_NAME}'
      - '--region=${_REGION}'
      - '--class=org.apache.hadoop.examples.terasort.TeraGen'
      - '--jars=file:///usr/lib/hadoop-mapreduce/hadoop-mapreduce-examples.jar'
      - '--'
      - '100'
      - 'gs://${_BUCKET_NAME}/${REPO_NAME}/${BRANCH_NAME}/${COMMIT_SHA}/temp/test/output/teragen_output'

  ## Run pi-spark test
  - name: 'gcr.io/cloud-builders/gcloud'
    args:
      - 'dataproc'
      - 'jobs'
      - 'submit'
      - 'spark'
      - '--cluster=${_CLUSTER_NAME}'
      - '--region=${_REGION}'
      - '--jars=file:///usr/lib/spark/examples/jars/spark-examples.jar'
      - '--class=org.apache.spark.examples.JavaSparkPi'
      - '--'
      - '3'

  # delete single node dataproc cluster
  - name: 'gcr.io/cloud-builders/gcloud'
    args:
      - 'dataproc'
      - 'clusters'
      - 'delete'
      - '${_CLUSTER_NAME}'
      - '--region=${_REGION}'

  # remove temp resources
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'remove_temp_resources'
    args:
      - 'rm'
      - '-r'
      - 'gs://${_BUCKET_NAME}/${REPO_NAME}/${BRANCH_NAME}/${COMMIT_SHA}/temp'

  # copy to work dir
  - name: gcr.io/$PROJECT_ID/manifest-util
    args: ['--git_sha', '$COMMIT_SHA',
           '--git_brunch', '$BRANCH_NAME',
           '--build_id', '$BUILD_ID',
           '--upload' ]
    id: 'set-manifest'
    dir: 'dataproc/'